# QoL Framework Architecture

## Overview

The QoL Framework is a modular userscript framework that provides a unified UI and shared utilities for multiple userscripts.

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                      Browser Page                            │
│                                                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │           QoL Framework (IIFE)                     │    │
│  │                                                     │    │
│  │  ┌──────────────────────────────────────────────┐ │    │
│  │  │  Global QoL Object                           │ │    │
│  │  │  - version                                   │ │    │
│  │  │  - scripts[]                                 │ │    │
│  │  │  - registerScript()                          │ │    │
│  │  │  - init()                                    │ │    │
│  │  └──────────────────────────────────────────────┘ │    │
│  │                                                     │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌───────────┐ │    │
│  │  │   UI Core   │  │   Storage   │  │   Utils   │ │    │
│  │  │             │  │             │  │           │ │    │
│  │  │ • Toolbar   │  │ • get()     │  │ • create  │ │    │
│  │  │ • Modal     │  │ • set()     │  │ • wait    │ │    │
│  │  │ • Toasts    │  │ • remove()  │  │ • debounce│ │    │
│  │  └─────────────┘  └─────────────┘  └───────────┘ │    │
│  │                                                     │    │
│  │  ┌─────────────┐  ┌─────────────┐                 │    │
│  │  │    Deps     │  │  Registry   │                 │    │
│  │  │             │  │             │                 │    │
│  │  │ • load()    │  │ • scripts[] │                 │    │
│  │  │ • cache     │  │ (metadata)  │                 │    │
│  │  └─────────────┘  └─────────────┘                 │    │
│  │                                                     │    │
│  │  ┌──────────────────────────────────────────────┐ │    │
│  │  │  Glassmorphic Styles (Injected CSS)          │ │    │
│  │  └──────────────────────────────────────────────┘ │    │
│  └────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌────────────────┐  ┌────────────────┐  ┌──────────────┐ │
│  │  Script 1      │  │  Script 2      │  │  Script N    │ │
│  │  (IIFE)        │  │  (IIFE)        │  │  (IIFE)      │ │
│  │                │  │                │  │              │ │
│  │ registerScript │  │ registerScript │  │ registerScript│ │
│  │   ↓            │  │   ↓            │  │   ↓          │ │
│  │ init()         │  │ init()         │  │ init()       │ │
│  │ destroy()      │  │ destroy()      │  │ destroy()    │ │
│  └────────────────┘  └────────────────┘  └──────────────┘ │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## Component Breakdown

### Core Framework (`src/`)

#### `index.js` - Main Entry
- Exposes global `window.QoL` object
- Initializes framework on page load
- Manages script registration
- Coordinates all core modules

#### `ui.js` - User Interface
- **Toolbar**: Fixed bottom-left glassmorphic panel
  - Settings button
  - Script toggle buttons
  - Hover effects and animations
- **Modal**: Centered settings dialog
  - Per-script sections
  - Dynamic form controls
  - Responsive layout
- **Toasts**: Notification system
  - Success, info, warning, error types
  - Auto-dismiss with animations

#### `store.js` - Persistent Storage
- Namespaced key-value storage per script
- Uses `GM_getValue`/`GM_setValue`
- Automatic JSON serialization
- Isolation between scripts

#### `deps.js` - Dependency Management
- CDN library loader with caching
- Prevents duplicate loads
- Supports Turndown, Readability
- Promise-based async API

#### `utils.js` - Shared Utilities
- DOM manipulation helpers
- Element waiting/watching
- Debounce/throttle functions
- ID generation
- Deep cloning

#### `registry.js` - Script Manifest
- Auto-generated by `tools/integrate.js`
- Contains metadata for all scripts
- Used by UI to display available scripts

#### `styles.js` - CSS Injection
- Dark glassmorphism design system
- Responsive breakpoints
- Smooth animations
- Scrollbar styling

### Build Tools (`tools/`)

#### `new-script.js`
- Interactive CLI for scaffolding
- Validates script ID format
- Checks for duplicates
- Generates boilerplate code

#### `check-scripts.js`
- Validates all scripts in `scripts/`
- Checks for duplicate IDs
- Verifies required fields
- Basic syntax validation

#### `integrate.js`
- Scans `scripts/` directory
- Extracts metadata from each script
- Regenerates `registry.js`
- Runs before build

#### `build.js`
- Uses esbuild for bundling
- Builds framework as IIFE
- Copies scripts to `dist/`
- Injects userscript headers

## Data Flow

### Script Registration Flow
```
1. User creates script → scripts/my-script.user.js
2. Script calls QoL.registerScript({ ... })
3. Framework validates config
4. Framework stores script in QoL.scripts[]
5. Framework checks enabled state from storage
6. If enabled, calls script.init()
7. UI adds button to toolbar
```

### Settings Flow
```
1. User clicks settings button
2. Modal opens with all script sections
3. User changes a setting
4. onChange handler fires
5. QoL.store.set(scriptId, key, value)
6. GM_setValue stores to browser
7. Script can read with QoL.store.get()
```

### Dependency Loading Flow
```
1. Script calls await QoL.deps.load('turndown')
2. Check if library is in cache
3. If cached, return immediately
4. If not, GM_xmlhttpRequest to CDN
5. Execute library code in sandbox
6. Extract global constructor
7. Cache for future use
8. Return to script
```

### Toggle Flow
```
1. User clicks script button in toolbar
2. toggleScript(scriptId) called
3. Current state read from storage
4. New state = !currentState
5. QoL.store.set(scriptId, 'enabled', newState)
6. If enabling: call script.init()
7. If disabling: call script.destroy()
8. Update button visual state
9. Show toast notification
```

## File Structure

```
qol-userscripts/
├── src/                    # Framework source
│   ├── core/              # Core modules
│   │   ├── ui.js          # UI components
│   │   ├── store.js       # Storage API
│   │   ├── utils.js       # Utilities
│   │   ├── deps.js        # Dependency loader
│   │   └── registry.js    # Script manifest (auto-generated)
│   ├── styles.js          # CSS styles
│   └── index.js           # Main entry point
│
├── scripts/               # Individual userscripts
│   └── *.user.js         # Script files
│
├── tools/                 # Build and dev tools
│   ├── new-script.js     # Script scaffolder
│   ├── check-scripts.js  # Validator
│   ├── integrate.js      # Registry generator
│   └── build.js          # esbuild bundler
│
├── dist/                  # Build output
│   ├── qol-framework.user.js      # Bundled framework
│   ├── qol-framework.user.js.map  # Source map
│   └── *.user.js                  # Individual scripts
│
├── package.json           # npm config
├── README.md             # Full documentation
├── QUICKSTART.md         # Quick start guide
└── ARCHITECTURE.md       # This file
```

## Design Patterns

### Module Pattern
Each core module exports functions that operate on internal state:
```javascript
// store.js
const STORAGE_PREFIX = 'qol_';  // Private

export function get(scriptId, key, defaultValue) {  // Public
  // Implementation
}
```

### Registry Pattern
Scripts register themselves with the framework:
```javascript
QoL.registerScript({
  id: 'my-script',
  init() { /* ... */ },
  destroy() { /* ... */ }
});
```

### Observer Pattern
UI components react to state changes:
```javascript
// When setting changes
store.set(scriptId, key, value);
// UI automatically updates
updateToolbarButton(scriptId, value);
```

### Dependency Injection
Scripts request dependencies from framework:
```javascript
const Turndown = await QoL.deps.load('turndown');
```

### Factory Pattern
UI controls are created based on type:
```javascript
switch (config.type) {
  case 'toggle': return createToggle(...);
  case 'text': return createTextInput(...);
  // ...
}
```

## Extension Points

### Adding New Setting Types
1. Add case in `createSettingControl()` in `ui.js`
2. Create corresponding `create*()` function
3. Handle value storage/retrieval
4. Update documentation

### Adding New Dependencies
1. Add CDN URL to `DEPS` object in `deps.js`
2. Update loader logic if needed
3. Document usage in README

### Custom UI Components
Scripts can create their own UI using:
- `QoL.utils.createElement()`
- Framework CSS classes
- Glassmorphism design tokens

## Performance Considerations

- **Lazy Loading**: Dependencies loaded on-demand
- **Caching**: Libraries cached after first load
- **Event Delegation**: Minimal event listeners
- **Debouncing**: Input handlers debounced
- **Tree Shaking**: esbuild removes unused code
- **Source Maps**: Debugging without performance hit

## Security

- **Namespace Isolation**: Each script has own storage namespace
- **No eval()**: Dependencies loaded via Function constructor
- **CSP Compatible**: No inline scripts in HTML
- **Sandboxed Execution**: Scripts run in userscript sandbox
- **Validated Inputs**: All user inputs sanitized

## Browser Compatibility

- **Target**: ES2020+ (Chrome 90+, Firefox 88+, Safari 14+)
- **Userscript Managers**: Tampermonkey, Violentmonkey, Greasemonkey
- **Required APIs**: GM_getValue, GM_setValue, GM_xmlhttpRequest
- **Optional APIs**: GM_addStyle (fallback available)

## Future Enhancements

- [ ] Hot reload during development
- [ ] Script marketplace/sharing
- [ ] Keyboard shortcuts API
- [ ] Theme customization
- [ ] Script dependencies (script A requires script B)
- [ ] Performance monitoring
- [ ] Error reporting
- [ ] Automatic updates
- [ ] Import/export settings
- [ ] Script templates library
